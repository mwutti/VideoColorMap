<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Color Map</title>
    <script type="text/javascript" src="../js/jquery-3.1.1.js"></script>
    <script type="text/javascript" src="../js/application.js"></script>
    <script type="text/javascript" src="../js/jcanvas.min.js"></script>

    <style type="text/css">
        #colorMapCanvas {
            width: 100%;
            height: 100%;
            margin-top: 50px;

        }
    </style>

</head>
<body>
<video id="videoTag" controls></video>

<form id="inputForm">
    <label for="inputVideo" title="Choose an Video">Choose a video</label>
    <input id="inputVideo" type="file" accept="video/*">
    <button type="submit">OK</button>
</form>

<div id="colorMap">
    <canvas
            id="hiddenCanvas"
            height="360"
            width="640"
            style="width: 320px; height: 180px; border: 1px solid black;"
            hidden>
    </canvas>
</div>
<script type="text/javascript">
    var inputForm = $('#inputForm');
    var inputVideo = document.querySelector('input');

    var videoTag = document.querySelector('video');
    var videoWidth;
    var videoHeight;

    var URL = window.URL || window.webkitURL;
    var interval = 20; // alle 10 Sekunden wird ein Frame aus dem Video entnommen
    var duration; // Länge des Videos
    var colorMap = $('#colorMap');



    $(document).ready(function() {



    });

    /**
     *  Nachdem ein Video ausgewählt wurde, wird dem <video/>-Element das Video zugewiesen;
     *  Zu beachten ist hierbei, dass die URL zum Abspielen des Videos eine lokale URL ist
     *  und somit muss man mittels Web-API  URL.createObjectURL() eine Url erzeugen die auf die lokale Datei zeigt.
     *  (Sonst könnte man via Script jede beliebige Datei im Dateisystem des Clients laden).
     */
    inputForm.on('submit', function(event) {
        event.preventDefault();

        var videoFile = inputVideo.files[0];
        var videoType = videoFile.type;
        var canPlay = videoTag.canPlayType(videoType);


        if (canPlay === '') {
            alert('Unable to play Video. Supported file formats are: MP4, OGG, MebM');
            return;
        } else {
            videoTag.src = URL.createObjectURL(videoFile);

            var intervalID = setInterval(function(){
                if (videoTag.readyState > 0) {
                    clearInterval(intervalID);
                    videoWidth = videoTag.videoWidth;
                    videoHeight = videoTag.videoHeight;

                    //Mit der Erzeugung der ColorMap beginnen
                    doMagicStuff();
                }
            }, 200);
        }
    });

    function doMagicStuff() {
        duration = parseInt(videoTag.duration);
        var frameAt = interval;

        //Wenn der sich der Frame ändert, wird er extrahiert und bearbeitet
        videoTag.addEventListener('seeked', function () {
//            var imageCanvas = document.getElementById('hiddenCanvas').cloneNode(true);
            var imageCanvas = document.createElement('canvas');
            var context = imageCanvas.getContext('2d');

            imageCanvas.height = videoHeight;
            imageCanvas.width = videoHeight;
            imageCanvas.id = 'image' + frameAt;

//            Video wird zugeschnitten
            context.drawImage(videoTag, (videoWidth - videoHeight)/2, 0, (videoWidth - videoHeight)/2, videoHeight, 0, 0, videoHeight, videoHeight);
//            context.drawImage(videoTag, 320, 0, 320, 180, 0, 0, 640, 360)


//            debugger;
//            context.clearRect(0,0, imageCanvas.width, imageCanvas.width);
//
//            context.scale(300/videoTag.videoWidth,300/videoTag.videoHeight);


            frameAt = frameAt + interval;


            colorMap.append(imageCanvas);
            imageCanvas.removeAttribute('hidden');
            if (frameAt <= duration) {
                videoTag.currentTime = frameAt;
            }
        });
        videoTag.currentTime = frameAt;
    }




</script>
</body>
</html>