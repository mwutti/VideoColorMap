<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Color Map</title>
    <script type="text/javascript" src="../js/jquery-3.1.1.js"></script>
    <script type="text/javascript" src="../js/application.js"></script>
    <script type="text/javascript" src="../js/jcanvas.min.js"></script>

    <style type="text/css">
        #colorMapCanvas {
            width: 100%;
            height: 100%;
            margin-top: 50px;

        }
    </style>

</head>
<body>
<video id="videoTag" controls></video>

<form id="inputForm">
    <label for="inputVideo" title="Choose an Video">Choose a video</label>
    <input id="inputVideo" type="file" accept="video/*">
    <button type="submit">OK</button>
</form>

<div id="colorMap">
    <canvas
            id="hiddenCanvas"
            height="360"
            width="640"
            style="width: 320px; height: 180px; border: 1px solid black;"
            hidden>
    </canvas>
</div>
<script type="text/javascript">
    var inputForm = $('#inputForm');
    var colorMap = $('#colorMap');
    var inputVideo = document.querySelector('input');
    var videoTag = document.querySelector('video');

    var videoWidth;
    var videoHeight;
    var targetHeight = 200;

    var URL = window.URL || window.webkitURL;
    var interval = 20; // alle 10 Sekunden wird ein Frame aus dem Video entnommen
    var duration; // Länge des Videos

    // Eine Map die in der die einzelnen Frames {dominantColor, {canvas}} gespeichert werden.
    var imageMap = {}


    /**
     *  Nachdem ein Video ausgewählt wurde, wird dem <video/>-Element das Video zugewiesen;
     *  Zu beachten ist hierbei, dass die URL zum Abspielen des Videos eine lokale URL ist
     *  und somit muss man mittels Web-API  URL.createObjectURL() eine Url erzeugen die auf die lokale Datei zeigt.
     *  (Sonst könnte man via Script jede beliebige Datei im Dateisystem des Clients laden).
     */
    inputForm.on('submit', function(event) {
        event.preventDefault();

        var videoFile = inputVideo.files[0];
        var videoType = videoFile.type;
        var canPlay = videoTag.canPlayType(videoType);


        if (canPlay === '') {
            alert('Unable to play Video. Supported file formats are: MP4, OGG, MebM');
            return;
        } else {
            videoTag.src = URL.createObjectURL(videoFile);

            var intervalID = setInterval(function(){
                if (videoTag.readyState > 0) {
                    clearInterval(intervalID);
                    videoWidth = videoTag.videoWidth;
                    videoHeight = videoTag.videoHeight;

                    //Mit der Erzeugung der ColorMap beginnen
                    doMagicStuff();
                }
            }, 200);
        }
    });

    function doMagicStuff() {
        duration = parseInt(videoTag.duration);
        var frameAt = interval;

        /**
         * Jedes mal wenn sich ein Frame im Video ändert, wird die Bearbeitung ausgeführt
         **/
        videoTag.addEventListener('seeked', function () {
            var imageCanvas = document.createElement('canvas');
            var context = imageCanvas.getContext('2d');
            /**
             * Zuerst wird ein Canvas Element erstellt, das die Originalgröße des Videos hat und  auf dessen Basis
             * die dominante Farbe berechnet wird
             */
            imageCanvas.height = videoHeight;
            imageCanvas.width = videoWidth;
            imageCanvas.id = 'image' + frameAt;

            context.drawImage(videoTag, 0, 0);

            var dominantColor = getDominantColor(imageCanvas);
            debugger;
            if (imageMap[dominantColor] == undefined) {
                imageMap[dominantColor] = [];
            }
            imageMap[dominantColor].push(imageCanvas);

//            var scaleFactor = targetHeight/videoHeight;
//            imageCanvas.height = videoHeight * scaleFactor;
//            imageCanvas.width = videoHeight * scaleFactor;
//
//
//            //Video wird zugeschnitten
//            context.drawImage(videoTag, (videoWidth - videoHeight)/2, 0, (videoWidth - videoHeight)/2, videoHeight, 0, 0, videoHeight * scaleFactor, videoHeight * scaleFactor);


            frameAt = frameAt + interval;

//            colorMap.append(imageCanvas);
//            imageCanvas.removeAttribute('hidden');

            //remove this
            //appendDominantColor(dominantColor);

            if (frameAt <= duration) {
                videoTag.currentTime = frameAt;
            } else {
                //Gibt das Zeichen, das alle dominanten Farben und Frames vorhanden sind
                colorMap.trigger("ready");
            }
        });

        //Initialer Anstoß der Erzeugung zur ColorMap
        videoTag.currentTime = frameAt;
    }

    colorMap.on('ready', function() {
        //keys sortieren
        var keys = [];

        $.each(imageMap, function(key, value) {
          keys.push(key);
        });

        keys.sort();


    });

    function getDominantColor(canvas) {
        var result;
        var dictionary = {};
        var context = canvas.getContext('2d');
        var imageData = context.getImageData(0, 0, videoWidth, videoHeight).data;

        for (i = 0; i < imageData.length; i+=40) {
            var red = imageData[i];
            var green = imageData[i+1];
            var blue = imageData[i+2];
//            var alpha = imageData[i+3];

            //integer rep
//            var rgb = (red << 24) + (green << 16) + (blue << 8) + (alpha);
            var rgb = rgbToHex(componentToHex(red), componentToHex(green), componentToHex(blue));

            if (dictionary[rgb] == undefined) {
                dictionary[rgb] = 1;
            } else {
                dictionary[rgb] = dictionary[rgb] + 1;
            }
        }

        var max = 0;

        $.each(dictionary, function(key, value) {
            if (value > max) {
                max = value;
                result = key;
            }
        });

        return result;
    }

    function componentToHex(c) {
        var hex = c.toString(16);
        return hex.length == 1 ? "0" + hex : hex;
    }

    function rgbToHex(r, g, b) {
        return componentToHex(r) + componentToHex(g) + componentToHex(b);
    }


    function appendDominantColor(dominantColor) {
        var colorcanvas = document.createElement('canvas');
        colorcanvas.height = 100;
        colorcanvas.width = 100;

        var context2d = colorcanvas.getContext('2d');
        context2d.fillStyle = '#' + dominantColor;
        context2d.fillRect(0,0,100,100);
        colorMap.append(colorcanvas);
    }

</script>
</body>
</html>